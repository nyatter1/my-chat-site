<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VikVok Live | Infinite Flow</title>
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');

        :root {
            --bg-color: #050208;
            --card-bg: #0f0a18;
            --primary-violet: #8b5cf6;
            --deep-purple: #4c1d95;
            --text-white: #f5f3ff;
            --text-gray: #a78bfa;
            --glass: rgba(255, 255, 255, 0.05);
            --red-like: #ff3b5c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-white); height: 100vh; overflow: hidden; }

        .nebula-bg {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle at 20% 30%, #2e1065 0%, transparent 40%),
                        radial-gradient(circle at 80% 70%, #4c1d95 0%, transparent 40%);
            filter: blur(80px); z-index: -1;
        }

        /* --- UI TOAST --- */
        #custom-alert {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(15, 10, 24, 0.9); backdrop-filter: blur(15px);
            border: 1px solid var(--primary-violet); border-radius: 20px;
            padding: 16px 30px; display: flex; align-items: center; gap: 15px;
            z-index: 100000; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        #custom-alert.active { top: 30px; }

        /* --- AUTH SECTION --- */
        #auth-screen { display: flex; align-items: center; justify-content: center; height: 100%; }
        .container { background-color: var(--card-bg); border-radius: 40px; position: relative; overflow: hidden; width: 850px; min-height: 600px; border: 1px solid rgba(255,255,255,0.05); }
        .form-container { position: absolute; top: 0; height: 100%; transition: 0.6s; width: 50%; }
        .sign-in { left: 0; z-index: 2; }
        .sign-up { left: 0; opacity: 0; z-index: 1; }
        .container.active .sign-in { transform: translateX(100%); opacity: 0; }
        .container.active .sign-up { transform: translateX(100%); opacity: 1; z-index: 5; }
        form { background: var(--card-bg); display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 0 40px; height: 100%; }
        
        .input-group { width: 100%; background: var(--glass); margin: 8px 0; padding: 14px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: 10px; }
        .input-group input { background: transparent; border: none; outline: none; color: white; width: 100%; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-violet), var(--deep-purple)); color: white; border: none; padding: 16px; border-radius: 15px; font-weight: 700; width: 100%; cursor: pointer; }

        /* --- DASHBOARD --- */
        #dashboard { display: none; height: 100vh; grid-template-columns: 280px 1fr 300px; }
        .sidebar { border-right: 1px solid rgba(255,255,255,0.05); padding: 30px; display: flex; flex-direction: column; background: rgba(15, 10, 24, 0.4); }
        .nav-item { display: flex; align-items: center; gap: 15px; color: var(--text-gray); padding: 14px; border-radius: 15px; cursor: pointer; margin-bottom: 5px; font-weight: 600; text-decoration: none; transition: 0.3s; }
        .nav-item.active, .nav-item:hover { background: var(--glass); color: var(--primary-violet); }

        /* --- NOTIFICATION PANEL --- */
        #notif-panel {
            position: absolute; left: 290px; top: 80px; width: 320px; max-height: 400px;
            background: var(--card-bg); border: 1px solid var(--primary-violet);
            border-radius: 20px; padding: 20px; display: none; flex-direction: column;
            z-index: 999; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .notif-item { padding: 10px; border-bottom: 1px solid var(--glass); font-size: 0.85rem; }

        /* --- FEED --- */
        .feed-scroll-container { height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; }
        .feed-scroll-container::-webkit-scrollbar { display: none; }
        .video-card { height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; scroll-snap-align: start; position: relative; }
        .video-wrapper { width: 440px; height: 88vh; background: #000; border-radius: 35px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .main-player { width: 100%; height: 100%; object-fit: cover; }

        /* --- ENGAGEMENT --- */
        .engagement-bar { position: absolute; right: 15px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 10; }
        .action-btn { background: rgba(255,255,255,0.1); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; cursor: pointer; color: white; border: 1px solid rgba(255,255,255,0.1); }
        .action-btn.liked { color: var(--red-like); border-color: var(--red-like); }
        .action-label { font-size: 0.75rem; font-weight: 700; }

        /* MODAL */
        #upload-modal { position: fixed; inset: 0; background: rgba(5,2,8,0.95); backdrop-filter: blur(50px); display: none; align-items: center; justify-content: center; z-index: 99999; }
        .modal-content { background: var(--card-bg); width: 450px; padding: 40px; border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }

        .toggle-container { position: absolute; top: 0; left: 50%; width: 50%; height: 100%; overflow: hidden; transition: 0.6s; z-index: 1000; }
        .container.active .toggle-container { transform: translateX(-100%); }
        .toggle { background: linear-gradient(135deg, #2e1065, #0f0a18); height: 100%; width: 200%; position: relative; left: -100%; transition: 0.6s; }
        .container.active .toggle { transform: translateX(50%); }
        .toggle-panel { position: absolute; width: 50%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 0 40px; }
        .btn-ghost { background: transparent; border: 2px solid white; color: white; padding: 10px 30px; border-radius: 10px; cursor: pointer; margin-top: 15px; }
        
        /* VOLUME PILL */
        .volume-container { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 15px 8px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .volume-slider { -webkit-appearance: none; width: 100px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 10px; transform: rotate(-90deg); margin: 45px 0; cursor: pointer; }

        .controls-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: flex-end; padding: 30px; background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 40%); opacity: 0; transition: 0.3s; pointer-events: none; }
        .video-wrapper:hover .controls-overlay { opacity: 1; pointer-events: auto; }
        .progress-box { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px; }
        .progress-fill { height: 100%; width: 0%; background: var(--primary-violet); border-radius: 10px; }

        .follow-badge { font-size: 0.7rem; background: var(--primary-violet); padding: 2px 8px; border-radius: 5px; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="nebula-bg"></div>
    <div id="custom-alert"><i class="ri-notification-3-fill"></i><span id="alert-message"></span></div>

    <div id="auth-screen">
        <div class="container" id="container">
            <div class="form-container sign-up">
                <form id="signup-form">
                    <h1>Create Account</h1>
                    <div class="input-group"><i class="ri-user-line"></i><input type="text" id="up-user" placeholder="Username" required></div>
                    <div class="input-group"><i class="ri-mail-line"></i><input type="email" id="up-email" placeholder="Email" required></div>
                    <div class="input-group"><i class="ri-lock-line"></i><input type="password" id="up-pass" placeholder="Password" required></div>
                    <button type="submit" class="btn-primary">Sign Up</button>
                </form>
            </div>
            <div class="form-container sign-in">
                <form id="login-form">
                    <h1>Welcome Back</h1>
                    <div class="input-group"><i class="ri-mail-line"></i><input type="email" id="in-email" placeholder="Email" required></div>
                    <div class="input-group"><i class="ri-lock-line"></i><input type="password" id="in-pass" placeholder="Password" required></div>
                    <button type="submit" class="btn-primary">Login</button>
                </form>
            </div>
            <div class="toggle-container">
                <div class="toggle">
                    <div class="toggle-panel"><h2>Member?</h2><button class="btn-ghost" id="loginToggle">Sign In</button></div>
                    <div class="toggle-panel" style="right:0"><h2>New?</h2><button class="btn-ghost" id="registerToggle">Sign Up</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboard">
        <aside class="sidebar">
            <h2 style="color:var(--primary-violet); margin-bottom: 30px;">VIKVOK</h2>
            <nav>
                <div class="nav-item active" onclick="goHome()"><i class="ri-home-7-fill"></i> Home</div>
                <div class="nav-item"><i class="ri-compass-3-line"></i> Explore</div>
                <div class="nav-item"><i class="ri-chat-3-line"></i> Messages</div>
                <div class="nav-item" onclick="toggleNotifs()"><i class="ri-notification-3-line"></i> Notifications</div>
            </nav>
            <div id="notif-panel">
                <h4 style="margin-bottom: 10px;">Recent Activity</h4>
                <div id="notif-list"></div>
            </div>
            <button class="btn-primary" onclick="toggleModal(true)" style="margin-top:20px; padding:15px;">CREATE</button>
            <button onclick="logout()" class="nav-item" style="margin-top:auto; background:none; border:none; cursor:pointer;"><i class="ri-logout-box-line"></i> Logout</button>
        </aside>

        <main class="feed-scroll-container" id="feed"></main>

        <section style="padding: 30px; border-left: 1px solid rgba(255,255,255,0.05);">
            <a href="profile.html" style="display:flex; align-items:center; gap:12px; background:var(--glass); padding:15px; border-radius:20px; text-decoration:none; color:inherit;">
                <div style="width:45px; height:45px; background:var(--primary-violet); border-radius:12px; display:flex; align-items:center; justify-content:center; font-weight:800;" id="user-init">?</div>
                <div><p style="font-size:0.7rem; opacity:0.5;">YOUR PROFILE</p><p id="user-display" style="font-weight:700;">Guest</p></div>
            </a>
        </section>
    </div>

    <div id="upload-modal">
        <div class="modal-content">
            <h2>Upload Video</h2>
            <p style="font-size: 0.8rem; margin-bottom: 15px; opacity: 0.6;">Select an MP4 file from your device</p>
            <div class="input-group">
                <i class="ri-file-upload-line"></i>
                <input type="file" id="v-file" accept="video/mp4,video/x-m4v,video/*">
            </div>
            <div class="input-group"><i class="ri-edit-line"></i><input type="text" id="v-cap" placeholder="Caption..."></div>
            <button class="btn-primary" id="upload-btn" onclick="uploadVideo()" style="width:100%; margin-top:10px; padding:15px;">Publish</button>
            <p onclick="toggleModal(false)" style="margin-top:15px; cursor:pointer; opacity:0.5;">Cancel</p>
        </div>
    </div>

    <script>
        const container = document.getElementById('container');
        document.getElementById('registerToggle').addEventListener('click', () => container.classList.add("active"));
        document.getElementById('loginToggle').addEventListener('click', () => container.classList.remove("active"));

        function triggerAlert(msg) {
            document.getElementById('alert-message').innerText = msg;
            document.getElementById('custom-alert').classList.add('active');
            setTimeout(() => document.getElementById('custom-alert').classList.remove('active'), 3000);
        }

        // --- PERSISTENT LOGIN CHECK ---
        window.onload = () => {
            const savedUser = localStorage.getItem('vikvok_u');
            if(savedUser) {
                enterDash(savedUser);
            }
        };

        function goHome() {
            // Home button no longer logs out, just refreshes feed
            loadFeed();
            triggerAlert("Feed Updated");
        }

        function logout() {
            localStorage.removeItem('vikvok_u');
            location.reload();
        }

        // --- SIGNUP/LOGIN ---
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                username: document.getElementById('up-user').value,
                email: document.getElementById('up-email').value,
                password: document.getElementById('up-pass').value
            };
            const res = await fetch('/api/signup', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(res.ok) {
                localStorage.setItem('vikvok_u', data.user.username);
                enterDash(data.user.username);
            } else triggerAlert(data.error);
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                email: document.getElementById('in-email').value,
                password: document.getElementById('in-pass').value
            };
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(res.ok) {
                localStorage.setItem('vikvok_u', data.username);
                enterDash(data.username);
            } else triggerAlert(data.error);
        });

        function enterDash(user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'grid';
            document.getElementById('user-display').innerText = user;
            document.getElementById('user-init').innerText = user.charAt(0).toUpperCase();
            loadFeed();
            loadNotifications();
        }

        // --- NOTIFICATIONS ---
        async function loadNotifications() {
            const user = localStorage.getItem('vikvok_u');
            const res = await fetch(`/api/notifications/${user}`);
            const data = await res.json();
            const list = document.getElementById('notif-list');
            list.innerHTML = data.length ? '' : '<p style="opacity:0.5; font-size:0.8rem;">No new activity</p>';
            data.forEach(n => {
                list.innerHTML += `<div class="notif-item"><b>${n.fromUser}</b> ${n.message.split(' ').slice(1).join(' ')}</div>`;
            });
        }

        function toggleNotifs() {
            const panel = document.getElementById('notif-panel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
            loadNotifications();
        }

        // --- FOLLOW SYSTEM ---
        async function followUser(target) {
            const currentUser = localStorage.getItem('vikvok_u');
            if(currentUser === target) return triggerAlert("You can't follow yourself!");
            
            const res = await fetch('/api/follow', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ currentUser, targetUser: target })
            });
            if(res.ok) triggerAlert(`Following @${target}`);
        }

        // --- FEED & VIDEO ---
        async function loadFeed() {
            const res = await fetch('/api/videos');
            const videos = await res.json();
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            videos.forEach(v => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.innerHTML = `
                    <div class="video-wrapper">
                        <video class="main-player" loop src="${v.videoUrl}"></video>
                        <div class="engagement-bar">
                            <div class="action-btn" onclick="likeVideo('${v._id}', this)"><i class="ri-heart-3-fill"></i></div>
                            <span class="action-label">${v.likes}</span>
                            <div class="action-btn" onclick="followUser('${v.username}')"><i class="ri-user-add-line"></i></div>
                            <span class="action-label">Follow</span>
                        </div>
                        <div class="controls-overlay">
                            <div class="volume-container">
                                <i class="ri-volume-up-fill"></i>
                                <input type="range" class="volume-slider" min="0" max="1" step="0.1" value="0.5">
                            </div>
                            <div class="video-meta">
                                <a href="profile.html?u=${v.username}" style="color:var(--primary-violet); font-weight:800; text-decoration:none;">@${v.username}</a>
                                <p>${v.caption}</p>
                                <div class="progress-box"><div class="progress-fill"></div></div>
                            </div>
                        </div>
                    </div>`;
                feed.appendChild(card);
                initPlayer(card);
            });
        }

        // --- FILE UPLOAD ---
        async function uploadVideo() {
            const fileInput = document.getElementById('v-file');
            const captionInput = document.getElementById('v-cap');
            const btn = document.getElementById('upload-btn');

            if(!fileInput.files[0]) return triggerAlert("Please select a video file!");
            
            btn.innerText = "Uploading...";
            btn.disabled = true;

            const formData = new FormData();
            formData.append('videoFile', fileInput.files[0]);
            formData.append('username', localStorage.getItem('vikvok_u'));
            formData.append('caption', captionInput.value);

            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData // No Headers needed for FormData
                });
                if(res.ok) {
                    toggleModal(false);
                    loadFeed();
                    triggerAlert("Video Published!");
                } else {
                    triggerAlert("Upload Failed!");
                }
            } catch (err) {
                triggerAlert("Error connecting to server");
            } finally {
                btn.innerText = "Publish";
                btn.disabled = false;
            }
        }

        function toggleModal(s) { document.getElementById('upload-modal').style.display = s ? 'flex' : 'none'; }

        function initPlayer(card) {
            const v = card.querySelector('video');
            const wrapper = card.querySelector('.video-wrapper');
            const progress = card.querySelector('.progress-fill');
            const vol = card.querySelector('.volume-slider');

            wrapper.onclick = (e) => { if(!e.target.closest('.action-btn')) v.paused ? v.play() : v.pause(); };
            v.ontimeupdate = () => progress.style.width = (v.currentTime / v.duration) * 100 + '%';
            vol.oninput = (e) => v.volume = e.target.value;
            vol.onclick = (e) => e.stopPropagation();
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const v = entry.target.querySelector('video');
                if (entry.isIntersecting) v.play(); else v.pause();
            });
        }, { threshold: 0.7 });

        setInterval(() => {
            document.querySelectorAll('.video-card').forEach(card => observer.observe(card));
        }, 1500);
    </script>
</body>
</html>
