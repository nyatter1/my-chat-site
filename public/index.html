<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyatter / Home Global</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Quicksand', sans-serif; background: radial-gradient(circle at top right, #1e293b, #0f172a); color: #f8fafc; height: 100vh; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border-right: 1px solid rgba(255, 255, 255, 0.05); border-left: 1px solid rgba(255, 255, 255, 0.05); }
        .rainbow-text { background: linear-gradient(to right, #ff4d4d, #f97316, #fbbf24, #4ade80, #60a5fa, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .hidden { display: none !important; }
        .meow-btn { background: linear-gradient(90deg, #4f46e5, #7c3aed); box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); transition: transform 0.1s; }
        .meow-btn:active { transform: scale(0.95); }
        .input-nyan { background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.75rem; color: white; }
        #emoji-picker { background: #1e293b; border: 1px solid rgba(255,255,255,0.1); display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 10px; position: absolute; z-index: 100; border-radius: 12px; bottom: 60px; left: 0; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .emoji-btn { cursor: pointer; font-size: 1.2rem; transition: transform 0.2s; }
        .emoji-btn:hover { transform: scale(1.3); }
        .post-img { max-height: 350px; width: 100%; object-fit: cover; border-radius: 1rem; margin-top: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .pinned-post { border-left: 4px solid #fbbf24 !important; background: rgba(251, 191, 36, 0.03) !important; }
        .dev-badge { background: linear-gradient(to right, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; font-size: 0.7rem; border: 1px solid #6366f1; padding: 0 4px; border-radius: 4px; }
        .post-card { transition: background 0.2s; }
        .post-card:hover { background: rgba(255, 255, 255, 0.02); }
    </style>
</head>
<body class="flex justify-center">

    <div id="auth-ui" class="w-full max-w-[420px] self-center bg-slate-800/60 p-10 rounded-[2rem] border border-white/10 shadow-2xl">
        <div class="flex justify-center mb-6"><img src="logo.png" alt="Nyatter" class="w-20 h-20 object-contain"></div>
        <div id="login-form">
            <h1 class="text-3xl font-bold mb-6 text-center">Login to <span class="rainbow-text">Nyatter</span></h1>
            <input type="text" id="login-user" placeholder="Username" class="w-full px-5 py-3 input-nyan mb-4 outline-none">
            <input type="password" id="login-pass" placeholder="Password" class="w-full px-5 py-3 input-nyan mb-6 outline-none">
            <button onclick="login()" class="w-full py-3 meow-btn rounded-xl font-bold text-white">Login</button>
            <p class="text-center mt-6 text-slate-400 text-sm">Need an account? <button onclick="toggleView()" class="text-indigo-400 font-bold">Sign up</button></p>
        </div>
        <div id="signup-form" class="hidden">
            <h1 class="text-3xl font-bold mb-6 text-center text-white">Join <span class="rainbow-text">Nyatter</span></h1>
            <input type="text" id="reg-user" placeholder="Choose Username" class="w-full px-5 py-3 input-nyan mb-4 outline-none">
            <input type="password" id="reg-pass" placeholder="Create Password" class="w-full px-5 py-3 input-nyan mb-6 outline-none">
            <button onclick="signup()" class="w-full py-3 meow-btn rounded-xl font-bold text-white">Sign Up</button>
            <p class="text-center mt-6 text-slate-400 text-sm">Member? <button onclick="toggleView()" class="text-indigo-400 font-bold">Login</button></p>
        </div>
    </div>

    <div id="app-ui" class="hidden w-full max-w-[1300px] flex h-screen">
        <aside class="w-1/4 max-w-[280px] flex flex-col p-4 glass-panel">
            <div class="mb-8 px-4 py-2"><img src="logo.png" alt="Nyatter" class="w-12 h-12"></div>
            <nav class="flex-1 space-y-2">
                <div class="flex items-center gap-4 px-4 py-3 text-xl font-bold text-white bg-indigo-500/10 rounded-full cursor-pointer"><span>üè†</span> Home</div>
                <div class="flex items-center gap-4 px-4 py-3 text-xl font-bold text-slate-400 hover:bg-white/5 rounded-full cursor-not-allowed"><span>üîî</span> Alerts</div>
                <div class="flex items-center gap-4 px-4 py-3 text-xl font-bold text-slate-400 hover:bg-white/5 rounded-full cursor-not-allowed"><span>‚úâÔ∏è</span> Meow-Box</div>
            </nav>
            <div class="mt-auto p-4 border-t border-white/5">
                <div class="flex items-center gap-3">
                    <img src="default.png" class="w-10 h-10 rounded-full border border-white/20">
                    <div>
                        <p class="font-bold text-sm text-white" id="user-tag"></p>
                        <div id="dev-tag-sidebar" class="hidden"><span class="dev-badge">DEVELOPER üõ†Ô∏è</span></div>
                    </div>
                </div>
                <button onclick="logout()" class="w-full mt-4 py-2 bg-slate-800/50 rounded-lg text-xs text-red-400 font-bold border border-red-400/20">Logout System</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col glass-panel border-x h-full">
            <header class="p-4 border-b border-white/5 bg-slate-900/60 backdrop-blur-md flex justify-between items-center">
                <h2 class="text-xl font-bold">Global Transmission</h2>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-[10px] uppercase font-bold text-slate-500">Live Sync</span>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto custom-scroll" id="main-scroll">
                <div class="p-4 border-b border-white/5 bg-slate-900/20">
                    <div class="flex gap-4">
                        <img src="default.png" class="w-12 h-12 rounded-full border border-white/10 shrink-0">
                        <div class="flex-1 relative">
                            <textarea id="meow-content" placeholder="What's your frequency?" class="w-full bg-transparent text-xl outline-none resize-none h-24 pt-2 text-white"></textarea>
                            <div id="preview-area" class="preview-box"></div>
                            
                            <div class="flex justify-between items-center border-t border-white/5 pt-4">
                                <div class="flex gap-4 items-center">
                                    <label class="cursor-pointer text-xl hover:scale-125 transition-transform">üñºÔ∏è<input type="file" id="post-file" class="hidden" accept="image/*" onchange="handleFile(event)"></label>
                                    <span class="cursor-pointer text-xl hover:scale-125 transition-transform" onclick="toggleEmoji()">üòÉ</span>
                                </div>
                                <button onclick="postMeow()" class="px-10 py-2.5 meow-btn rounded-full font-bold text-white uppercase tracking-tighter">Post Meow</button>
                            </div>

                            <div id="emoji-picker" class="hidden">
                                <span class="emoji-btn" onclick="insertEmoji('üò∫')">üò∫</span><span class="emoji-btn" onclick="insertEmoji('üåà')">üåà</span>
                                <span class="emoji-btn" onclick="insertEmoji('‚ú®')">‚ú®</span><span class="emoji-btn" onclick="insertEmoji('üöÄ')">üöÄ</span>
                                <span class="emoji-btn" onclick="insertEmoji('üî•')">üî•</span><span class="emoji-btn" onclick="insertEmoji('üíØ')">üíØ</span>
                                <span class="emoji-btn" onclick="insertEmoji('üòÇ')">üòÇ</span><span class="emoji-btn" onclick="insertEmoji('üíé')">üíé</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="feed" class="divide-y divide-white/5"></div>
            </div>
        </main>

        <aside class="w-1/3 max-w-[350px] p-6 h-full space-y-6">
            <div class="bg-slate-800/40 rounded-3xl p-6 border border-white/5">
                <h3 class="text-xl font-bold mb-6">Galactic Trends</h3>
                <div class="space-y-6">
                    <div>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Trending in Galaxy</p>
                        <p class="font-bold text-indigo-400">#NyanNet2025</p>
                        <p class="text-xs text-slate-500">12.4k Meows</p>
                    </div>
                    <div>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Dev Corner</p>
                        <p class="font-bold text-white">#HaydenControl</p>
                        <p class="text-xs text-slate-500">Direct Uplink</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        let currentImg = null;
        let currentUser = null;
        let activeInput = false; // Prevents laggy clearing
        const DEV_NAME = "HaydenDev";

        window.onload = () => {
            const saved = localStorage.getItem('currentUser');
            if (saved) loginSuccess(saved);
        };

        function toggleView() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
        }

        function login() {
            const u = document.getElementById('login-user').value.trim();
            if(!u) return;
            loginSuccess(u);
        }

        function signup() { login(); }

        function loginSuccess(u) {
            currentUser = u;
            localStorage.setItem('currentUser', u);
            document.getElementById('auth-ui').classList.add('hidden');
            document.getElementById('app-ui').classList.remove('hidden');
            document.getElementById('user-tag').innerText = "@" + u;
            if(u === DEV_NAME) document.getElementById('dev-tag-sidebar').classList.remove('hidden');
            
            renderFeed();
            setInterval(() => { if(!activeInput) renderFeed(); }, 3000);
        }

        function handleFile(e) {
            const reader = new FileReader();
            reader.onload = () => {
                currentImg = reader.result;
                document.getElementById('preview-area').innerHTML = `<img src="${currentImg}" class="post-img h-32 w-auto mb-4 border-2 border-indigo-500">`;
            };
            if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
        }

        function toggleEmoji() { document.getElementById('emoji-picker').classList.toggle('hidden'); }
        function insertEmoji(e) { document.getElementById('meow-content').value += e; toggleEmoji(); }

        async function postMeow() {
            const txt = document.getElementById('meow-content').value.trim();
            if(!txt && !currentImg) return;
            await fetch('/api/posts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user: currentUser, text: txt, img: currentImg })
            });
            document.getElementById('meow-content').value = "";
            document.getElementById('preview-area').innerHTML = "";
            currentImg = null;
            renderFeed();
        }

        async function deletePost(id) {
            if(!confirm("Erase from existence?")) return;
            await fetch('/api/posts/delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, user: currentUser })
            });
            renderFeed();
        }

        async function togglePin(id) {
            await fetch('/api/posts/pin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, user: currentUser })
            });
            renderFeed();
        }

        async function toggleLike(id) {
            await fetch('/api/posts/like', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, user: currentUser })
            });
            renderFeed();
        }

        async function addReply(id) {
            const inp = document.getElementById(`re-${id}`);
            if(!inp.value.trim()) return;
            await fetch('/api/posts/reply', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, user: currentUser, text: inp.value })
            });
            activeInput = false;
            renderFeed();
        }

        async function renderFeed() {
            try {
                const res = await fetch('/api/posts');
                const posts = await res.json();
                const container = document.getElementById('feed');
                
                container.innerHTML = posts.map(p => `
                    <div class="p-5 post-card ${p.pinned ? 'pinned-post' : ''}">
                        <div class="flex gap-4">
                            <img src="default.png" class="w-12 h-12 rounded-full border border-white/10 shrink-0">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-white">@${p.user}</span>
                                        ${p.user === DEV_NAME ? '<span class="dev-badge">DEV üõ†Ô∏è</span>' : ''}
                                        ${p.pinned ? '<span class="text-amber-400 text-[10px] font-bold uppercase tracking-widest">üìå PINNED</span>' : ''}
                                    </div>
                                    <div class="flex gap-3">
                                        ${currentUser === DEV_NAME ? `<button onclick="togglePin('${p._id}')" class="text-[10px] text-slate-500 hover:text-amber-400">PIN</button>` : ''}
                                        ${(p.user === currentUser || currentUser === DEV_NAME) ? `<button onclick="deletePost('${p._id}')" class="text-[10px] text-red-500/50 hover:text-red-500">DELETE</button>` : ''}
                                    </div>
                                </div>
                                <p class="text-slate-200 mt-2 text-[15px] leading-relaxed whitespace-pre-wrap">${p.text}</p>
                                ${p.img ? `<img src="${p.img}" class="post-img shadow-2xl">` : ''}
                                
                                <div class="flex gap-8 mt-4 text-xs font-bold text-slate-500">
                                    <button onclick="toggleLike('${p._id}')" class="flex items-center gap-2 ${p.likes?.includes(currentUser) ? 'text-pink-500' : ''}">
                                        ${p.likes?.includes(currentUser) ? '‚ù§Ô∏è' : 'ü§ç'} ${p.likes?.length || 0}
                                    </button>
                                    <div class="flex items-center gap-2">üí¨ ${p.replies?.length || 0}</div>
                                </div>

                                <div class="mt-4 space-y-3 pl-4 border-l border-white/5">
                                    ${p.replies?.map(r => `
                                        <div class="text-[13px] text-slate-300">
                                            <span class="text-indigo-400 font-bold">@${r.user}</span>: ${r.text}
                                        </div>
                                    `).join('') || ''}
                                    <div class="flex gap-2 mt-2">
                                        <input id="re-${p._id}" 
                                               onfocus="activeInput=true" 
                                               onblur="setTimeout(()=>activeInput=false, 200)"
                                               placeholder="Reply to frequency..." 
                                               class="flex-1 bg-slate-900/40 border border-white/5 rounded-full px-4 py-1.5 text-xs text-white outline-none focus:border-indigo-500">
                                        <button onclick="addReply('${p._id}')" class="text-indigo-400 text-[10px] font-bold uppercase">Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch(e) {}
        }

        function logout() { localStorage.removeItem('currentUser'); location.reload(); }
    </script>
</body>
</html>
